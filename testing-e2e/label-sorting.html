<!DOCTYPE html>
<html class="h-full">
  <head>
    <title>Zea Engine</title>
    <link rel="stylesheet" href="styles/tailwind.min.css" />
  </head>
  <body class="bg-blue-100 h-full">
    <div class="h-full">
      <canvas id="viewport"></canvas>
    </div>

    <script src="../dist/index.umd.js"></script>

    <script type="module">
      const {
        GLRenderer,
        Scene,
        Vec3,
        Xfo,
        Color,
        TreeItem,
        BillboardItem,
        Label,
        Material,
        Sphere,
        GeomItem,
      } = zeaEngine

      const scene = new Scene()
      const domElement = document.getElementById('viewport')
      const renderer = new GLRenderer(domElement, { hideSplash: true, antialias: false })
      renderer.setScene(scene)

      scene.setupGrid(4, 4)

      const standardMaterial = new Material('surfaces', 'SimpleSurfaceShader')
      standardMaterial.getParameter('BaseColor').setValue(new Color(89 / 255, 182 / 255, 92 / 255))

      const sphere = new Sphere(1.5, 8, 1)
      const geomItem = new GeomItem('Sphere', sphere, standardMaterial)
      scene.getRoot().addChild(geomItem)

      const asset = new TreeItem('labels')
      scene.getRoot().addChild(asset)

      let index = 0
      const addLabel = (lineEndPos, pos, color, name) => {
        return new Promise((resolve, reject) => {
          const label = new Label(name)
          label.getParameter('FontSize').setValue(48)
          label.getParameter('FontColor').setValue(color)
          label.getParameter('BackgroundColor').setValue(new Color(0.3, 0.3, 0.3))

          const billboard = new BillboardItem('billboard' + index, label)
          const xfo = new Xfo(pos)
          billboard.getParameter('LocalXfo').setValue(xfo)
          billboard.getParameter('PixelsPerMeter').setValue(300)
          // billboard.getParameter('AlignedToCamera').setValue(false)
          billboard.getParameter('AlignedToCamera').setValue(true)
          billboard.getParameter('DrawOnTop').setValue(false)
          billboard.getParameter('Alpha').setValue(0.5)
          // billboard.getParameter('lineEnd').addElement(lineEndPos)
          // billboard.getChildByName('line0').getMaterial().getParameter('Color').setValue(new Color(.7, .7, .7))
          asset.addChild(billboard)

          index++

          label.on('labelRendered', resolve)
        })
      }

      let promises = []

      // notes: the bug can occur when label that is behind renders in front due to angle of camera

      promises.push(addLabel(new Vec3(0, 0, 0), new Vec3(0, 0.0, 1.5), new Color(0, 1, 0), 'billboard 0'))

      promises.push(addLabel(new Vec3(0, 0, 0), new Vec3(0, 0.5, 1.5), new Color(1, 0, 0), '------ billboard 1 ------'))

      promises.push(addLabel(new Vec3(0, 0, 0), new Vec3(0, 10, 1.5), new Color(1, 1, 0), 'billboard 2'))

      Promise.all(promises).then(() => {
        window.postMessage(`done-Loading`)
      })

      renderer.getViewport().on('pointerDown', (event) => {})

      // {{{ Messages handler.
      const handleMessage = (event) => {
        const { data } = event

        if (data === 'front') {
          renderer.getViewport().getCamera().setPositionAndTarget(new Vec3(2, 2, 2.7), new Vec3(0, 0, 0.4))
          renderer.frameAll()
          window.postMessage(`done-${data}`)
        } else if (data === 'back') {
          renderer.getViewport().getCamera().setPositionAndTarget(new Vec3(-2, -2, 2.7), new Vec3(0, 0, 0.4))
          renderer.frameAll()
          window.postMessage(`done-${data}`)
        }
      }

      window.addEventListener('message', handleMessage, false)
      // }}}
    </script>
  </body>
</html>
