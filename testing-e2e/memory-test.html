<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Memory test - Zea Engine</title>

    <link href="zea-logo.png" rel="shortcut icon" />

    <style>
      .hidden {
        display: none;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/filesize@6.1.0/lib/filesize.min.js"></script>

    <script src="../dist/index.umd.js"></script>

    <script type="module">
      const {
        Vec3,
        EulerAngles,
        Xfo,
        Color,
        Cuboid,
        Material,
        GeomItem,
        TreeItem,
        Scene,
        GLRenderer,
      } = window.zeaEngine

      const canvas = document.getElementById('renderer')
      const renderer = new GLRenderer(canvas, { hideSplash: true, webglOptions: { antialias: false } })

      const scene = new Scene()

      const cuboid = new Cuboid(0.3, 0.4, 0.5)

      const count = 160_000
      const dim = Math.round(Math.cbrt(count))
      console.log('Will render GeomItem count:', Math.pow(dim, 3))
      renderer
        .getViewport()
        .getCamera()
        .setPositionAndTarget(new Vec3(dim * 2, dim * 2, dim), new Vec3(dim * 0.5, dim * 0.5, dim * 0.5))

      document.querySelector('#start').addEventListener('click', () => {
        document.querySelector('#wrapper').classList.remove('hidden')

        const start = performance.now()

        const onDone = () => {
          console.timeEnd('Create scene')

          console.time('Load GPU')
          renderer.setScene(scene)
          console.timeEnd('Load GPU')

          const totalTime = performance.now() - start

          const { usedJSHeapSize } = performance.memory

          const MEMORY_LIMIT = 1_620_000_000
          const TIME_LIMIT = 45_000

          const isGoodMemory = usedJSHeapSize <= MEMORY_LIMIT
          const isGoodTime = totalTime <= TIME_LIMIT

          const memoryStatus = isGoodMemory ? 'Good' : `Bad: ${window.filesize(usedJSHeapSize)}`
          const timeStatus = isGoodTime ? 'Good' : `Bad: ${Math.round(totalTime / 1000)} sec`

          console.log('Used Memory:', window.filesize(usedJSHeapSize))

          /*
        // Reference numbers from Phils Laptop.
        Create scene: 14765.61865234375 ms
        Load GPU: 11439.541748046875 ms
        Used Memory: 1.56 GB
        */

          document.querySelector('#memoryStatus').textContent = memoryStatus
          document.querySelector('#timeStatus').textContent = timeStatus
        }

        console.time('Create scene')
        let t1 = performance.now()
        let total = 0
        const addRow = (i) => {
          const t2 = performance.now()
          document.querySelector('#progressStatus').textContent = `progress: ${Math.round(
            (i / dim) * 100
          )}%, ${Math.round(t2 - t1)}`
          total += t2 - t1
          t1 = t2

          const treeItemI = new TreeItem('TreeItem' + i)

          for (let j = 0; j < dim; j++) {
            const material = new Material('mat', 'SimpleSurfaceShader')
            material.getParameter('BaseColor').setValue(new Color(i / dim, j / dim, 1))
            const treeItemJ = new TreeItem('TreeItem' + j)

            for (let k = 0; k < dim; k++) {
              const geomItem = new GeomItem('Geom' + k, cuboid, material)

              const xfo = new Xfo()
              xfo.tr.set(i, j, k)
              geomItem.getParameter('GlobalXfo').setValue(xfo)

              treeItemJ.addChild(geomItem)
            }

            treeItemI.addChild(treeItemJ)
          }

          scene.getRoot().addChild(treeItemI)
        }
        const addRowAsync = (i) => {
          return new Promise((resolve) => {
            setTimeout(() => {
              addRow(i)
              resolve()
            })
          })
        }
        const promises = []
        for (let i = 0; i < dim; i++) {
          promises.push(addRowAsync(i))
        }
        Promise.all(promises).then(onDone)
      })
    </script>
  </head>
  <body>
    <h1>Zea Engine Memory Test</h1>

    <p>Click the <button id="start">Start</button> button to begin.</p>

    <div class="hidden" id="wrapper">
      <dl>
        <dt>Memory:</dt>
        <dd>
          <p id="memoryStatus"></p>
        </dd>
        <dt>Time:</dt>
        <dd>
          <p id="timeStatus"></p>
        </dd>
        <dt>Status:</dt>
        <dd>
          <p id="progressStatus"></p>
        </dd>
      </dl>

      <canvas id="renderer" />
    </div>
  </body>
</html>
