<!DOCTYPE html>
<html>
  <head>
    <title>memory-test</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import {
        Vec3,
        EulerAngles,
        Xfo,
        Color,
        Cuboid,
        Material,
        GeomItem,
        TreeItem,
        Scene,
        GLRenderer,
      } from './libs/zea-engine/dist/index.esm.js'

      const domElement = document.getElementById('app')

      const scene = new Scene()
      scene.setupGrid(10.0, 10)

      //
      const count = 160000
      const dim = Math.round(Math.cbrt(count))
      const cuboid = new Cuboid(0.3, 0.4, 0.5)
      const t0 = performance.now()

      for (let i = 0; i < dim; i++) {
        const treeItemI = new TreeItem('TreeItem' + i)
        for (let j = 0; j < dim; j++) {
          const material = new Material('mat', 'SimpleSurfaceShader')
          material.getParameter('BaseColor').setValue(Color.random(0.4))
          const treeItemJ = new TreeItem('TreeItem' + j)
          for (let k = 0; k < dim; k++) {
            const geomItem = new GeomItem('Geom' + k, cuboid, material)

            const xfo = new Xfo()
            xfo.tr.set(i, j, k)
            geomItem.getParameter('GlobalXfo').setValue(xfo)

            treeItemJ.addChild(geomItem)
          }
          treeItemI.addChild(treeItemJ)
        }
        scene.getRoot().addChild(treeItemI)
      }
      const t1 = performance.now()

      const renderer = new GLRenderer(domElement, { hideSplash: true, webglOptions: { antialias: false } })
      renderer.setScene(scene)
      renderer.frameAll()

      const t2 = performance.now()
      console.log(
        `Done memory test. GeomItem count:${dim * dim * dim}. Create Scene time: ${t1 - t0}ms. Load GPU time: ${
          t2 - t1
        }ms`
      )

      window.postMessage(`done-Loading`)
    </script>
  </body>
</html>
