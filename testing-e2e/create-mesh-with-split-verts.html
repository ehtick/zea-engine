<!DOCTYPE html>
<html class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>load-mesh-json - Zea Engine</title>

    <link href="data/zea-logo.png" rel="shortcut icon" />

    <link rel="stylesheet" href="styles/tailwind.min.css" />

    <script src="../dist/index.umd.development.js"></script>

    <script type="module">
      const { GLRenderer, Scene, Vec3, Mesh, Color, Material, GeomItem, Lines, Vec3Attribute } = window.zeaEngine

      const canvas = document.querySelector('#renderer')

      const scene = new Scene()
      const renderer = new GLRenderer(canvas, { hideSplash: true, antialias: false })
      renderer.setScene(scene)

      scene.setupGrid(10.0, 10)

      const mesh = new Mesh()

      const geomItem = new GeomItem('geom', mesh, new Material('mat', 'StandardSurfaceShader'))
      scene.getRoot().addChild(geomItem)
      mesh.setFaceCounts([2])
      mesh.setFaceVertexIndices(0, [0, 2, 1])
      mesh.setFaceVertexIndices(1, [0, 3, 2])
      mesh.setNumVertices(4)
      const positions = mesh.getVertexAttribute('positions')
      positions.setValue(0, new Vec3(1, 1, 1))
      positions.setValue(1, new Vec3(0, 1, 0))
      positions.setValue(2, new Vec3(1, 1, 0))
      positions.setValue(3, new Vec3(1, 0, 0))

      const normals = new Vec3Attribute()
      mesh.addVertexAttribute('normals', normals)
      const normal = new Vec3(1, 0, 0)
      normals.setFaceVertexValue(0, 0, normal)
      normals.setFaceVertexValue(0, 1, normal)
      normals.setFaceVertexValue(0, 2, normal)
      normal.set(0, 1, 0)
      normals.setFaceVertexValue(1, 0, normal)
      normals.setFaceVertexValue(1, 1, normal)
      normals.setFaceVertexValue(1, 2, normal)

      renderer
        .getViewport()
        .getCamera()
        .setPositionAndTarget(new Vec3(2, 1, 2.7), new Vec3(0, 0, 0.4))
      renderer.frameAll()
      window.postMessage('done-loading')

      // {{{ Messages handler.
      const handleMessage = event => {
        const { data } = event

        if (data === 'variant-01') {
          mesh.fromJSON({
            faceCounts: [4],
            faceVertexIndices: [0, 1, 2, 0, 2, 3, 3, 2, 4, 2, 1, 4],
            numVertices: 5,
            vertexAttributes: {
              positions: {
                dataType: 'Vec3',
                defaultScalarValue: 0.0,
                data: [0, 0, 0, 0, 1, 0, 0.7, 0.7, 0.2, 1, 0, 0, 0.7, 0.7, 0]
              }
            }
          })
          mesh.computeVertexNormals()

          edges.__numVertices = mesh.getNumVertices()
          edges.__indices = new Uint32Array(mesh.edgeVerts)
          edges.emit('geomDataTopologyChanged')

          hardEdges.__numVertices = mesh.getNumVertices()
          hardEdges.__indices = mesh.computeHardEdgesIndices()
          hardEdges.emit('geomDataTopologyChanged')

          renderer.frameAll()
          window.postMessage(`done-${data}`)
        } else if (data === 'variant-02') {
          mesh.fromJSON({
            faceCounts: [2],
            faceVertexIndices: [0, 1, 2, 0, 2, 3],
            numVertices: 4,
            vertexAttributes: {
              positions: {
                dataType: 'Vec3',
                defaultScalarValue: 0.0,
                data: [0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0]
              }
            }
          })
          mesh.computeVertexNormals()

          edges.__numVertices = mesh.getNumVertices()
          edges.__indices = new Uint32Array(mesh.edgeVerts)
          edges.emit('geomDataTopologyChanged')

          hardEdges.__numVertices = mesh.getNumVertices()
          hardEdges.__indices = mesh.computeHardEdgesIndices()
          hardEdges.emit('geomDataTopologyChanged')

          renderer.frameAll()
          window.postMessage(`done-${data}`)
        }
      }

      window.addEventListener('message', handleMessage, false)
      // }}}
    </script>
  </head>
  <body class="bg-blue-100 h-full">
    <div class="h-full">
      <canvas class="absolute" id="renderer"></canvas>
    </div>
  </body>
</html>
