<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>pointer-events - Zea Engine</title>

    <link href="zea-logo.png" rel="shortcut icon" />

    <link rel="stylesheet" href="styles/tachyons.min.css" />
    <link rel="stylesheet" href="styles/main.css" />

    <script src="../dist/index.umd.js"></script>

    <script type="module">
      const {
        GLRenderer,
        Scene,
        TreeItem,
        GeomItem,
        Cuboid,
        Cylinder,
        Torus,
        Cone,
        Xfo,
        Vec3,
        Color,
        Material,
        BillboardItem,
        Label,
        SelectionSet,
      } = window.zeaEngine

      const selfEventsIndicator = document.querySelector('#selfEventsIndicator')
      const groupEventsIndicator = document.querySelector('#groupEventsIndicator')
      const viewportEventsIndicator = document.querySelector('#viewportEventsIndicator')

      const canvas = document.querySelector('#renderer')

      const scene = new Scene()
      const renderer = new GLRenderer(canvas, { hideSplash: true, webglOptions: { antialias: false } })
      renderer.setScene(scene)

      // {{{ Self Events.
      const material1 = new Material('material1', 'SimpleSurfaceShader')
      material1.getParameter('BaseColor').setValue(new Color('#94C47D'))

      const selfEventItem = new GeomItem('CuboidGeometryItem', new Cuboid(0.7, 0.7, 0.7), material1)

      const selfEventItemXfo = new Xfo()
      selfEventItemXfo.tr = new Vec3(2, 0, 0.5)
      selfEventItem.getParameter('GlobalXfo').setValue(selfEventItemXfo)

      scene.getRoot().addChild(selfEventItem)

      let goToDefaultTextTimeout

      const startBackToDefaultTextTimeout = () => {
        goToDefaultTextTimeout = setTimeout(() => (selfEventsIndicator.textContent = INDICATORS_DEFAULT_TEXT), 2000)
      }

      const INDICATORS_DEFAULT_TEXT = '(None)'

      // Register pointer event handlers directly to the geometry.
      selfEventItem.on('pointerEnter', (event) => {
        selfEventsIndicator.textContent = 'pointerEnter'
        clearTimeout(goToDefaultTextTimeout)
        window.postMessage('done-enter-geometry')
      })

      selfEventItem.on('pointerLeave', (event) => {
        selfEventsIndicator.textContent = 'pointerLeave'
        startBackToDefaultTextTimeout()

        window.postMessage('done-leave-geometry')
      })

      selfEventItem.on('pointerDown', (event) => {
        event.stopPropagation()

        selfEventsIndicator.textContent = 'pointerDown'
        clearTimeout(goToDefaultTextTimeout)
      })

      selfEventItem.on('pointerUp', (event) => {
        event.stopPropagation()
        selfEventsIndicator.textContent = 'pointerUp'
        startBackToDefaultTextTimeout()
      })
      // }}}

      // {{{ Group Events.
      {
        const material2 = new Material('material2', 'SimpleSurfaceShader')
        material2.getParameter('BaseColor').setValue(new Color('#F6B26B'))

        const groupItem1 = new GeomItem('CylinderGeometryItem', new Cylinder(0.3, 0.4), material2)

        const groupItem1Xfo = new Xfo()
        groupItem1Xfo.tr = new Vec3(0.35, 0, 0.5)
        groupItem1.getParameter('GlobalXfo').setValue(groupItem1Xfo)

        // ----------------------------------------------------------------------------------------

        const material3 = new Material('cylinderMaterial', 'SimpleSurfaceShader')
        material3.getParameter('BaseColor').setValue(new Color('#F6B26B'))

        const groupItem2 = new GeomItem('CylinderGeometryItem', new Torus(0.1, 0.3), material3)

        const groupItem2Xfo = new Xfo()
        groupItem2Xfo.tr = new Vec3(-0.45, 0, 0.5)
        groupItem2.getParameter('GlobalXfo').setValue(groupItem2Xfo)

        // ----------------------------------------------------------------------------------------

        scene.getRoot().addChild(groupItem1)
        scene.getRoot().addChild(groupItem2)

        const group = new SelectionSet('MyGroup')
        group.addItem(groupItem1)
        group.addItem(groupItem2)

        let goToDefaultTextTimeout
        const startBackToDefaultTextTimeout = () => {
          goToDefaultTextTimeout = setTimeout(() => (groupEventsIndicator.textContent = INDICATORS_DEFAULT_TEXT), 2000)
        }

        // Register pointer event handlers directly to the geometry.
        group.on('pointerEnter', (event) => {
          event.stopPropagation()

          groupEventsIndicator.textContent = 'pointerEnter'
          clearTimeout(goToDefaultTextTimeout)
        })

        group.on('pointerLeave', (event) => {
          event.stopPropagation()

          groupEventsIndicator.textContent = 'pointerLeave'
          startBackToDefaultTextTimeout()
        })

        group.on('pointerDown', (event) => {
          event.stopPropagation()

          group.getParameter('Highlighted').setValue(true)
          groupEventsIndicator.textContent = 'pointerDown'
          clearTimeout(goToDefaultTextTimeout)
          event.setCapture(group)
        })

        group.on('pointerUp', (event) => {
          event.stopPropagation()

          group.getParameter('Highlighted').setValue(false)
          groupEventsIndicator.textContent = 'pointerUp'
          startBackToDefaultTextTimeout()
          event.releaseCapture()
        })

        scene.getRoot().addChild(group)
      }
      // }}}

      // {{{ Pointer Events on viewport.
      {
        let goToDefaultTextTimeout
        const startBackToDefaultTextTimeout = () => {
          goToDefaultTextTimeout = setTimeout(
            () => (viewportEventsIndicator.textContent = INDICATORS_DEFAULT_TEXT),
            2000
          )
        }

        // Register pointer event handlers directly to the geometry.

        renderer.getViewport().on('pointerLeaveGeom', (event) => {
          viewportEventsIndicator.textContent = 'pointerLeaveGeom'
          startBackToDefaultTextTimeout()
        })

        renderer.getViewport().on('pointerOverGeom', (event) => {
          viewportEventsIndicator.textContent = 'pointerOverGeom'
          clearTimeout(goToDefaultTextTimeout)
        })

        renderer.getViewport().on('pointerDownOnGeom', (event) => {
          viewportEventsIndicator.textContent = 'pointerDownOnGeom'
          clearTimeout(goToDefaultTextTimeout)
        })

        renderer.getViewport().on('pointerUp', (event) => {
          viewportEventsIndicator.textContent = 'pointerUp'
          startBackToDefaultTextTimeout()
        })

        renderer.getViewport().on('pointerDown', (event) => {
          viewportEventsIndicator.textContent = 'pointerDown'
          startBackToDefaultTextTimeout()
        })
      }
      // }}}

      // Position the camera to a better perspective view.
      renderer.getViewport().getCamera().setPositionAndTarget(new Vec3(0, 5, 3), new Vec3(0, 0, 0))

      renderer
        .getViewport()
        .getCamera()
        .on('movementFinished', (e) => {
          if (e.event) {
            renderer.once('redrawOccurred', () => {
              window.postMessage('done-moving-camera')
            })
          }
        })
    </script>
  </head>
  <body class="flex flex-column">
    <h1>Zea Engine Pointer Events Test</h1>

    <dl>
      <dt class="dib b">Self:</dt>
      <dd>
        <p id="selfEventsIndicator">(None)</p>
      </dd>
      <dt class="dib b">Group:</dt>
      <dd>
        <p id="groupEventsIndicator">(None)</p>
      </dd>
      <dt class="dib b">Viewport:</dt>
      <dd>
        <p id="viewportEventsIndicator">(None)</p>
      </dd>
    </dl>

    <canvas class="flex-grow-1" id="renderer" />
  </body>
</html>
