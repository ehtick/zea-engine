<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Test Cutaways</title>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    </head>
    <body text-align: left;>

        <script src="../external/helpers.js"></script>
        <script src="../lib/Visualive-dev.js"></script>
        <script src="../lib/VisualiveUI-dev.js"></script>
        
        <script type="text/javascript">

    let div = addCanvas();
    let resources = generateResourcesDict(["/Assets/CutawayAndExplode.obj"]);
    let scene = new Visualive.Scene(resources);

    let asset = new Visualive.TreeItem('asset');

    let bigSphere = new Visualive.Sphere(8.0, 32, 32);
    let bigSphereMaterial = new Visualive.Material('bigSphereMaterial', 'SimpleSurfaceShader');
    bigSphereMaterial.addParameter('baseColor', new Visualive.Color(0.0, 1.0, 0.0));
    let bigSphereItem = new Visualive.GeomItem('bigSphere', bigSphere, bigSphereMaterial);
    asset.addChild(bigSphereItem, false);
    scene.getRoot().addChild(asset);


    /////////////////////////////////////
    // Obj Asset
    let objAsset = new Visualive.ObjAsset('obj', scene.getResourceLoader());
    objAsset.getParameter('splitObjects').setValue(false);
    objAsset.getParameter('splitGroupsIntoObjects').setValue(false);
    objAsset.getParameter('loadMtlFile').setValue(false);
    objAsset.getParameter('unitsConversion').setValue(1.0);
    objAsset.getParameter('defaultShader').setValue("SimpleCutawaySurfaceShader");
    scene.addAsset(objAsset);

    let cutAmount = -10.0;
    let cutParam = new Visualive.NumberParameter('planeDist', cutAmount, [-10, 10]);

    objAsset.loaded.connect(function() {
        renderer.frameAll();
        renderer.resumeDrawing();
        objAsset.getMaterialLibrary().getMaterialNames().forEach((materialName)=>{
            let material = objAsset.getMaterialLibrary().getMaterial(materialName);
            material.addParameterInstance(cutParam);
        });

        let animatingValue = false;
        let timeoutId;
        let timerCallback = () => {
            // Check to see if the video has progressed to the next frame. 
            // If so, then we emit and update, which will cause a redraw.
            animatingValue = true;
            cutAmount += 0.05;
            cutParam.setValue(cutAmount);
            renderer.requestRedraw();
            if (cutAmount < 10.0) {
                timeoutId = setTimeout(timerCallback, 20); // Sample at 50fps.
            }
            animatingValue = false;
        };
        timeoutId = setTimeout(timerCallback, 1000); // half second delay
        cutParam.valueChanged.connect(()=>{
            if(!animatingValue) {
                clearTimeout(timeoutId);
            }
        });


    });
    objAsset.getParameter('FilePath').setValue("/Assets/CutawayAndExplode.obj");


    let renderer = new Visualive.GLSimpleRenderer(div, { enableCrossSections:true });
    renderer.getViewport().getCamera().setPositionAndTarget(new Visualive.Vec3(8, 2, -8), new Visualive.Vec3(0, 0, 0));
    renderer.setScene(scene);


    //////////////////////////////////
    // Setup the UI

    let sliderController = new Visualive.SliderController(cutParam);

    let widgetPanel = new Visualive.UIWidgetPanel();
    widgetPanel.addWidgetController(sliderController);

    let uicontroller = new Visualive.UIController();
    uicontroller.addWidgetPanel(widgetPanel);


    VisualiveUI.renderUI(renderer, uicontroller);


        </script> 
    </body>
</html>
